{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
 <title>Verify Cow Data</title>
 <link rel="stylesheet" href="{% static 'styles.css' %}" />
</head>
<body>
 <div class="container">
 <h1>Verify Cow Data</h1>

 <button id="start-btn">Start Verification</button>

 <div id="camera-wrapper" style="position:relative; width:640px; height:480px;">
 <video id="video" width="640" height="480" autoplay muted playsinline></video>
 <canvas id="overlay" width="640" height="480" style="position:absolute; top:0; left:0;"></canvas>
 </div>

 <p id="status"></p>
 </div>

 <script>
 const video = document.getElementById("video");
 const canvas = document.getElementById("overlay");
 const ctx = canvas.getContext("2d");
 const startBtn = document.getElementById("start-btn");
 const statusText = document.getElementById("status");

 let socket;
 let stream;
 let captureInterval;

 // Function to stop the camera
 function stopCamera() {
 if (stream) {
 stream.getTracks().forEach(track => track.stop());
 console.log("Camera stopped.");
 }
 }

 // Function to start the camera
 async function startCamera() {
 try {
 console.log("Attempting to access the camera...");
 stream = await navigator.mediaDevices.getUserMedia({
 video: { facingMode: { exact: "environment" } },
 audio: false
 });
 console.log("Camera access successful.");
 video.srcObject = stream;
 } catch (err) {
 console.error("Camera Error:", err);
 statusText.innerText = "âŒ Could not access camera. Try another device.";
 }
 }

 // Function to draw a box on the canvas
 function drawBox(box, confidence) {
 const [x1, y1, x2, y2] = box;
 ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear previous drawings
 ctx.strokeStyle = "orange";
 ctx.lineWidth = 3;
 ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
 ctx.fillStyle = "orange";
 ctx.font = "20px Arial";
 ctx.fillText(`Conf: ${confidence.toFixed(2)}`, x1 + 5, y1 + 25);
 }

 startBtn.addEventListener("click", async () => {
 console.log("Start button clicked.");
 socket = new WebSocket(`wss://${window.location.host}/ws/cow/verify/`);

 socket.onopen = async () => {
 console.log("WebSocket connection opened.");
 statusText.innerText = "ðŸ”„ Connecting camera...";
 await startCamera();
 statusText.innerText = "ðŸ“· Streaming... Looking for muzzle...";

 captureInterval = setInterval(() => {
 const capture = document.createElement("canvas");
 capture.width = video.videoWidth;
 capture.height = video.videoHeight;
 capture.getContext("2d").drawImage(video, 0, 0, capture.width, capture.height);
 const frame = capture.toDataURL("image/jpeg");
 console.log("Sending frame to server...");
 socket.send(JSON.stringify({ image: frame }));
 }, 1000);
 };

 socket.onmessage = (e) => {
 console.log("Received WebSocket message:", e.data);
 const data = JSON.parse(e.data);
 if (data.box && data.confidence) {
 drawBox(data.box, data.confidence);
 }

 if (data.status === "success") {
 statusText.innerText = `âœ… Cow matched: ${data.cow_name}`;
 clearInterval(captureInterval);
 socket.close();
 stopCamera();
 } else if (data.status === "fail") {
 statusText.innerText = `âŒ No matching cow found.`;
 } else if (data.status === "error") {
 statusText.innerText = `âŒ Error: ${data.message}`;
 clearInterval(captureInterval);
 socket.close();
 stopCamera();
 }
 };

 socket.onerror = (err) => {
 console.error("WebSocket error:", err);
 statusText.innerText = "âŒ WebSocket error.";
 clearInterval(captureInterval);
 stopCamera();
 };

 socket.onclose = () => {
 console.log("WebSocket connection closed.");
 };
 });
 </script>
</body>
</html>