{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Cow Data</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>
<body>
    <div class="container">
        <h1>Upload Cow Data</h1>

        <!-- Video preview -->
        <div id="camera-preview">
            <video id="video" width="640" height="480" autoplay playsinline muted></video>
            <br>
            <button id="capture-btn">Capture Image</button><br>
        </div>

        <!-- Image preview after capture -->
        <div id="image-preview-container" style="display:none;">
            <img id="image-preview" width="640" height="480" alt="Captured Image">
        </div>

        <!-- Form for submission -->
        <form id="save-form" action="{% url 'upload_cow_data' %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="cow_image" id="cow_image">  <!-- Stores image in Base64 format -->
            <br>
            <label for="cow_name">Enter Cow Name:</label>
            <input type="text" name="cow_name" id="cow_name" placeholder="Enter Cow Name" required>
            <button type="submit">Submit</button>
        </form>
    </div>

    <script>
        const videoElement = document.getElementById('video');
        const captureButton = document.getElementById('capture-btn');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const form = document.getElementById('save-form');
        const cowImageInput = document.getElementById('cow_image');

        // Initialize Camera
        navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: { ideal: "environment" } // Uses rear camera if available
                }
            })
            .then(stream => {
                videoElement.srcObject = stream;
            })
            .catch(err => {
                console.error("Camera error:", err);
                alert("Camera access not available. Please check permissions.");
            });

        // Capture Image and Convert to Base64
        captureButton.addEventListener('click', function () {
            // Pause video to freeze frame
            videoElement.pause();

            // Create a canvas to capture the image
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            // Convert to Base64
            const dataUrl = canvas.toDataURL('image/jpeg'); // Base64 string
            cowImageInput.value = dataUrl; // Store Base64 in hidden input field

            // Show the captured image
            imagePreview.src = dataUrl;
            imagePreviewContainer.style.display = 'block';

            // Hide video and capture button
            videoElement.style.display = 'none';
            captureButton.style.display = 'none';

            // Show form
            form.style.display = 'block';
        });
    </script>
</body>
</html>
